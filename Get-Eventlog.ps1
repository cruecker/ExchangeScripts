### 
## Script will deliver Events from Eventlog of different Exchange Servers to an HTML Report
## Script V1.1
## Date 09.02.2021
## Code from Claudius Rücker
#load EMS

#hole die Exchange Server
$exservers = @()
$exservers = Get-ADGroup -Identity "Exchange Servers" |Get-ADGroupMember
$exservertoconect = $exservers[0].name

#load EMS
$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http://$exservertoconect/PowerShell/ -Authentication Kerberos
Import-PSSession $Session -DisableNameChecking

$time = (Get-Date) - (New-TimeSpan -Day 1)
$Ergebnisse = @()
$serverliste = get-exchangeserver


$serverliste | foreach {
                        Invoke-Command -ComputerName $_ -Command {Get-WinEvent –FilterHashtable @{logname='application'; Level=1; starttime=$using:time}} -AsJob
                        Invoke-Command -ComputerName $_ -Command {Get-WinEvent –FilterHashtable @{logname='application'; Level=2; starttime=$using:time}} -AsJob
                        Invoke-Command -ComputerName $_ -Command {Get-WinEvent –FilterHashtable @{logname='application'; Level=3; starttime=$using:time}} -AsJob
                        Invoke-Command -ComputerName $_ -Command {Get-WinEvent –FilterHashtable @{logname='system'; Level=1; starttime=$using:time}} -AsJob
                        Invoke-Command -ComputerName $_ -Command {Get-WinEvent –FilterHashtable @{logname='system'; Level=2; starttime=$using:time}} -AsJob
                        Invoke-Command -ComputerName $_ -Command {Get-WinEvent –FilterHashtable @{logname='system'; Level=3; starttime=$using:time}} -AsJob
                        }

#auf Abarbeitung des Jobs warten
Get-Job | Wait-Job

Get-Job | ForEach-Object {Try
                          {$Ergebnisse += Receive-Job -Job $_ -ErrorAction:Stop }
                          
                          catch [System.Management.Automation.RemoteException] {
                                                                                write-host "On server:" $Error[0].OriginInfo.PSComputerName $Error[0].Exception.Message -ForegroundColor yellow                                                                               }
                                                                                }

#Jobs entfernen
get-job | remove-job

#Fehler aufbereiten und Gruppieren
$fehler = $ergebnisse | select PSComputerName, TimeCreated, LevelDisplayName, LogName, Id, ProviderName, Message 
$fehlerAnzahl = ($fehler).count
$GruppierteFehler = $fehler | Group-Object -Property ID, PSComputername

#Fehler Zusammenfassen
$outputfehler = @()
foreach ($Gfehler in $GruppierteFehler) {
                                            $outputfehler += [PSCustomObject]@{
                                                'Anzahl' = $Gfehler.Count
                                                'ComputerName' = $GFehler[0].Group[0].PSComputerName
                                                'Time' = $GFehler[0].Group[0].TimeCreated
                                                'Name' = $GFehler[0].Group[0].LevelDisplayName
                                                'Log' = $GFehler[0].Group[0].LogName
                                                'ID' = $GFehler[0].Group[0].ID
                                                'Message' = $GFehler[0].Group[0].Message
                                                }
                                        }
#$outputfehler | ft

$precontent = “List of Errrors on Exchange Eventlog”
$htmlParams = @{
  Body = Get-Date
  PreContent = $precontent
  PostContent = "Es wurden seit dem " + "$time " + "$fehlerAnzahl " + "Fehler auf den Exchange Servern gefunden"
  Head = “<title>Applog Errors</title><style>table, th, td {border: 1px solid;}</style >”
}

$outputfehler | select |ConvertTo-Html @htmlParams | Out-File Eventlog.htm
Invoke-Item Eventlog.htm
